generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id        String      @id @default(uuid())
  name      String
  cnpj      String?     @unique
  type      CompanyType
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  users     User[]
  contracts Contract[]


  @@map("companies")
}

enum CompanyType {
  OWNER
  CLIENT
  PARTNER
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions Json
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]

  @@map("roles")
}

model User {
  id                 String               @id @default(uuid())
  email              String               @unique
  password           String
  fullName           String
  profilePhoto       String?
  companyId          String
  roleId             String
  isActive           Boolean              @default(true)
  isMaster           Boolean              @default(false)
  lastLogin          DateTime?
  passwordChangedAt  DateTime?
  mustChangePassword Boolean              @default(false)
  loginAttempts      Int                  @default(0)
  lockedUntil        DateTime?
  preferences        Json?
  // MFA Fields
  mfaEnabled         Boolean              @default(false)
  mfaSecret          String?
  mfaRecoveryCodes   String[]             @default([])
  // LGPD Fields
  gdprConsent        Boolean              @default(false)
  gdprConsentDate    DateTime?
  dataRetentionExpiry DateTime?
  anonymizedAt       DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  company            Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  role               Role                 @relation(fields: [roleId], references: [id])
  sessions           Session[]
  passwordResets     PasswordReset[]
  notifications      Notification[]
  auditLogs          AuditLog[]
  devices            Device[]
  termsAcceptances   TermsAcceptance[]
  dataDeletionRequests DataDeletionRequest[]

  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  ipAddress    String?
  userAgent    String?
  deviceId     String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@map("sessions")
}

model PasswordReset {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_resets")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())
  readAt    DateTime?
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

enum NotificationType {
  CONTRACT_EXPIRING
  MEASUREMENT_PENDING
  ACTION_REQUIRED
  SYSTEM_ALERT
}

model AuditLog {
  id                String      @id @default(uuid())
  userId            String?
  action            String
  module            String
  entityId          String?
  entityType        String?
  ipAddress         String?
  userAgent         String?
  deviceFingerprint String?
  status            AuditStatus
  metadata          Json?
  createdAt         DateTime    @default(now())
  user              User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditStatus {
  SUCCESS
  FAILURE
}

model Device {
  id          String   @id @default(uuid())
  userId      String
  fingerprint String
  name        String?
  trusted     Boolean  @default(false)
  lastUsedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fingerprint])
  @@index([userId])
  @@map("devices")
}

model TermsAcceptance {
  id           String   @id @default(uuid())
  userId       String
  termsVersion String
  acceptedAt   DateTime @default(now())
  ipAddress    String?
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("terms_acceptances")
}

model DataDeletionRequest {
  id          String    @id @default(uuid())
  userId      String
  requestedAt DateTime  @default(now())
  processedAt DateTime?
  status      String    @default("PENDING") // PENDING, APPROVED, COMPLETED, REJECTED
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("data_deletion_requests")
}

model Contract {
  id           String    @id @default(uuid())
  number       String    @unique
  object       String? // Objeto do contrato
  companyId    String
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  startDate    DateTime
  endDate      DateTime
  totalValue   Decimal   @default(0.0) @db.Decimal(15, 2)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  items        ContractItem[]
  addendums    ContractAddendum[]
  measurements Measurement[]
  projectDocuments ProjectDocument[]
  grds         GRD[]

  @@map("contracts")
}

enum ContractItemType {
  STAGE      // Etapa
  SUBSTAGE   // Sub-etapa
  LEVEL      // Nível
  SUBLEVEL   // Sub-nível
  GROUP      // Grupo
  SUBGROUP   // Sub-grupo
  ITEM       // Item
}

model ContractItem {
  id             String           @id @default(uuid())
  contractId     String
  contract       Contract         @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  // Hierarchy
  parentId       String?
  parent         ContractItem?    @relation("ItemHierarchy", fields: [parentId], references: [id])
  children       ContractItem[]   @relation("ItemHierarchy")
  
  type           ContractItemType
  code           String?
  description    String?
  orderIndex     Int              @default(0)
  techSpecs      String?          @map("tech_specs")
  
  // For SERVICES (Level 3)
  costCenter     String?          
  quantity       Decimal?         @db.Decimal(15, 3)
  unit           String?          
  unitPrice      Decimal?         @db.Decimal(15, 2)
  totalValue     Decimal?         @default(0.0) @db.Decimal(15, 2)
  
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  measurements   MeasurementItem[]
  addendumOperations AddendumOperation[]

  @@index([contractId])
  @@index([parentId])
  @@map("contract_items")
}

model MeasurementUnit {
  id          String   @id @default(uuid())
  code        String   @unique // m, m2, m3, un, kg
  description String?
  createdAt   DateTime @default(now())

  @@map("measurement_units")
}

// Tipos de operação do aditivo
enum AddendumOperationType {
  SUPPRESS      // Supressão total de item
  ADD           // Adição de novo item
  MODIFY_QTY    // Modificação de quantidade
  MODIFY_PRICE  // Modificação de preço unitário
  MODIFY_BOTH   // Modificação de quantidade e preço
}

model ContractAddendum {
  id            String             @id @default(uuid())
  contractId    String
  contract      Contract           @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  number        Int                // Número sequencial (1, 2, 3...)
  description   String             // Descrição/justificativa
  date          DateTime           // Data do aditivo
  status        String             @default("DRAFT") // DRAFT, APPROVED, CANCELLED
  
  // Valores totais calculados
  totalAddition    Decimal          @default(0) @db.Decimal(15, 2)
  totalSuppression Decimal          @default(0) @db.Decimal(15, 2)
  netValue         Decimal          @default(0) @db.Decimal(15, 2)
  
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  
  operations    AddendumOperation[]

  @@map("contract_addendums")
}

model AddendumOperation {
  id               String               @id @default(uuid())
  addendumId       String
  addendum         ContractAddendum     @relation(fields: [addendumId], references: [id], onDelete: Cascade)
  
  operationType    AddendumOperationType
  
  // Para MODIFY/SUPPRESS: referência ao item existente
  contractItemId   String?
  contractItem     ContractItem?        @relation(fields: [contractItemId], references: [id], onDelete: SetNull)
  
  // Para ADD: dados do novo item
  newItemType      String?              // STAGE, SUBSTAGE, ITEM, etc.
  newItemCode      String?
  newItemDescription String?
  newItemParentId  String?              // ID do pai para novos itens
  newItemUnit      String?
  
  // Valores originais (snapshot no momento da criação)
  originalQuantity Decimal?             @db.Decimal(15, 3)
  originalPrice    Decimal?             @db.Decimal(15, 2)
  
  // Novos valores
  newQuantity      Decimal?             @db.Decimal(15, 3)
  newPrice         Decimal?             @db.Decimal(15, 2)
  
  // Valor calculado da operação (positivo=acréscimo, negativo=supressão)
  operationValue   Decimal              @default(0) @db.Decimal(15, 2)
  
  createdAt        DateTime             @default(now())

  @@map("addendum_operations")
}

model Measurement {
  id          String            @id @default(uuid())
  contractId  String
  contract    Contract          @relation(fields: [contractId], references: [id], onDelete: Cascade)
  number      Int
  periodStart DateTime
  periodEnd   DateTime
  status      String            @default("DRAFT") // DRAFT, CLOSED, APPROVED
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  items       MeasurementItem[]
  approvals   MeasurementApproval[]

  @@map("measurements")
}

model MeasurementItem {
  id                  String       @id @default(uuid())
  measurementId       String
  measurement         Measurement  @relation(fields: [measurementId], references: [id], onDelete: Cascade)
  contractItemId      String
  contractItem        ContractItem @relation(fields: [contractItemId], references: [id], onDelete: Cascade)
  
  measuredQuantity    Decimal      @db.Decimal(15, 3)
  accumulatedQuantity Decimal      @db.Decimal(15, 3)
  currentPrice        Decimal      @db.Decimal(15, 2)
  
  createdAt           DateTime     @default(now())
  
  memories            MeasurementMemory[]
  photos              MeasurementPhoto[]
  metadata            Json?

  @@unique([measurementId, contractItemId])
  @@map("measurement_items")
}

model MeasurementPhoto {
  id                String          @id @default(uuid())
  measurementItemId String
  measurementItem   MeasurementItem @relation(fields: [measurementItemId], references: [id], onDelete: Cascade)
  
  filename          String          // Nome original do arquivo
  path              String          // Caminho no servidor
  mimeType          String          // image/jpeg, image/png, etc.
  size              Int             // Tamanho em bytes
  description       String?         // Descrição opcional
  photoDate         DateTime?       // Data da foto
  location          String?         // Local (estaca, km, ou texto livre)
  
  uploadedBy        String?         // ID do usuário que fez upload
  createdAt         DateTime        @default(now())
  
  @@map("measurement_photos")
}

model MeasurementMemory {
  id                String          @id @default(uuid())
  measurementItemId String
  measurementItem   MeasurementItem @relation(fields: [measurementItemId], references: [id], onDelete: Cascade)
  description       String?         // trecho/eixo
  startPoint        Decimal?        @db.Decimal(15, 3) // Estaca Inicial
  endPoint          Decimal?        @db.Decimal(15, 3) // Estaca Final
  length            Decimal?        @db.Decimal(15, 3) // Extensão
  width             Decimal?        @db.Decimal(15, 3) // Largura
  height            Decimal?        @db.Decimal(15, 3) // Altura/Espessura
  quantity          Decimal         @db.Decimal(15, 3) // Result
  
  metadata          Json?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@map("measurement_memories")
}

// ==========================================
// SISTEMA DE COMENTÁRIOS
// ==========================================

enum CommentTargetType {
  MEASUREMENT_ITEM
  CONTRACT_ITEM
  MEASUREMENT
  CONTRACT
}

model Comment {
  id                    String            @id @default(uuid())
  userId                String
  content               String
  targetType            CommentTargetType
  targetId              String            // ID do item alvo
  linkedItemId          String?           // ID do item de contrato vinculado (opcional)
  linkedItemCode        String?           // Código do item vinculado (snapshot)
  linkedItemDescription String?           // Descrição do item vinculado (snapshot)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([targetType, targetId])
  @@index([userId])
  @@map("comments")
}

// ==========================================
// SISTEMA DE APROVAÇÃO MULTI-NÍVEL
// ==========================================

model ApprovalLevel {
  id          String   @id @default(uuid())
  name        String   @unique // Ex: "Fiscalização", "Gerência", "Diretoria"
  level       Int      @unique // 1, 2, 3... (ordem de aprovação)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  approvals   MeasurementApproval[]

  @@map("approval_levels")
}

model MeasurementApproval {
  id              String        @id @default(uuid())
  measurementId   String
  measurement     Measurement   @relation(fields: [measurementId], references: [id], onDelete: Cascade)
  approvalLevelId String
  approvalLevel   ApprovalLevel @relation(fields: [approvalLevelId], references: [id])
  
  approvedById    String        // Usuário que aprovou
  approvedByName  String        // Nome do usuário (snapshot)
  approvedAt      DateTime      @default(now())
  notes           String?       // Observações da aprovação
  
  @@unique([measurementId, approvalLevelId])
  @@index([measurementId])
  @@map("measurement_approvals")
}

// ==========================================
// SISTEMA DE REVISÕES DE MEDIÇÃO
// ==========================================

model MeasurementRevision {
  id              String   @id @default(uuid())
  measurementId   String
  revisionNumber  Int
  reason          String   // Motivo da revisão
  snapshotData    Json     // Snapshot completo dos dados da medição
  createdById     String
  createdByName   String
  createdAt       DateTime @default(now())

  @@index([measurementId])
  @@map("measurement_revisions")
}

// ==========================================
// SISTEMA DE ANEXOS
// ==========================================

model Attachment {
  id              String   @id @default(uuid())
  targetType      String   // CONTRACT, MEASUREMENT, CONTRACT_ITEM
  targetId        String   // ID do item alvo
  filename        String   // Nome original do arquivo
  storedName      String   // Nome armazenado
  path            String   // Caminho no servidor
  mimeType        String
  size            Int      // Tamanho em bytes
  description     String?
  uploadedById    String?
  uploadedByName  String?
  createdAt       DateTime @default(now())

  @@index([targetType, targetId])
  @@map("attachments")
}

// ==========================================
// SISTEMA DE FAVORITOS
// ==========================================

model UserFavorite {
  id        String   @id @default(uuid())
  userId    String
  targetType String  // CONTRACT, MEASUREMENT
  targetId  String
  createdAt DateTime @default(now())

  @@unique([userId, targetType, targetId])
  @@index([userId])
  @@map("user_favorites")
}

// ==========================================
// SISTEMA DE CONTROLE DE DOCUMENTOS
// ==========================================

// Categorias/Disciplinas de documentos
model DocumentCategory {
  id          String   @id @default(uuid())
  code        String   @unique // ARQ, EST, ELE, HID, MEC, etc.
  name        String   // Arquitetura, Estrutural, etc.
  description String?
  color       String?  // Cor para exibição
  icon        String?  // Ícone
  orderIndex  Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  documents   ProjectDocument[]
  
  @@map("document_categories")
}

// Documento de projeto (DWG, PDF, etc.)
model ProjectDocument {
  id            String   @id @default(uuid())
  contractId    String?
  categoryId    String?
  
  // Identificação
  code          String   // Código do documento: PRJ-ARQ-001
  title         String
  description   String?
  
  // Arquivo
  fileName      String
  storedName    String
  filePath      String
  fileSize      Int
  mimeType      String
  
  // Versionamento
  revision      String   @default("R00") // R00, R01, R02...
  revisionDate  DateTime @default(now())
  
  // Status do workflow
  status        DocumentStatus @default(RECEIVED)
  
  // Timestamps do workflow
  receivedAt    DateTime @default(now())
  analyzedAt    DateTime?
  approvedAt    DateTime?
  distributedAt DateTime?
  releasedAt    DateTime?
  
  // Responsáveis
  uploadedById    String?
  uploadedByName  String?
  
  // Metadados
  author        String?  // Autor do projeto (projetista)
  discipline    String?  // Disciplina alternativa
  format        String?  // A0, A1, A2, A3, A4
  scale         String?  // 1:50, 1:100, etc.
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relações
  contract      Contract?  @relation(fields: [contractId], references: [id])
  category      DocumentCategory? @relation(fields: [categoryId], references: [id])
  versions      DocumentVersion[]
  analyses      CriticalAnalysis[]
  grdItems      GRDItem[]
  annotations   DocumentAnnotation[]
  
  @@index([contractId])
  @@index([categoryId])
  @@index([status])
  @@index([code])
  @@map("project_documents")
}

enum DocumentStatus {
  RECEIVED        // Recebido
  IN_ANALYSIS     // Em análise crítica
  APPROVED        // Aprovado
  APPROVED_NOTES  // Aprovado com ressalvas
  REJECTED        // Reprovado
  DISTRIBUTED     // Distribuído (GRD)
  RELEASED        // Liberado para obra
  SUPERSEDED      // Substituído por nova revisão
}

// Versões do documento
model DocumentVersion {
  id            String   @id @default(uuid())
  documentId    String
  revision      String   // R00, R01, R02...
  
  // Arquivo
  fileName      String
  storedName    String
  filePath      String
  fileSize      Int
  
  // Metadados
  changes       String?  // Descrição das alterações
  uploadedById  String?
  uploadedByName String?
  
  createdAt     DateTime @default(now())
  
  document      ProjectDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  @@index([documentId])
  @@map("document_versions")
}

// Análise Crítica
model CriticalAnalysis {
  id            String   @id @default(uuid())
  documentId    String
  
  // Revisor
  reviewerId    String?
  reviewerName  String?
  
  // Status
  status        AnalysisStatus @default(PENDING)
  result        AnalysisResult?
  
  // Conteúdo
  observations  String?  @db.Text
  pendencies    Json?    // Lista de pendências
  technicalNotes String? @db.Text
  
  // Prazos
  deadline      DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  document      ProjectDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  @@index([documentId])
  @@index([reviewerId])
  @@index([status])
  @@map("critical_analyses")
}

enum AnalysisStatus {
  PENDING       // Aguardando
  IN_PROGRESS   // Em andamento
  COMPLETED     // Concluída
}

enum AnalysisResult {
  APPROVED        // Aprovado
  REJECTED        // Reprovado
  APPROVED_NOTES  // Aprovado com ressalvas
}

// GRD - Guia de Remessa de Documentos
model GRD {
  id            String   @id @default(uuid())
  contractId    String
  
  // Identificação
  number        String   @unique // GRD-001/2026
  year          Int
  sequence      Int
  
  // Destinatário
  recipient       String
  recipientEmail  String?
  recipientPhone  String?
  recipientCompany String?
  
  // Envio
  sendMethod    GRDSendMethod @default(EMAIL)
  reason        GRDReason     @default(INITIAL)
  status        GRDStatus     @default(DRAFT)
  
  // Observações
  notes         String?
  
  // Datas
  sentAt        DateTime?
  confirmedAt   DateTime?
  
  // Responsável
  createdById   String?
  createdByName String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  contract      Contract  @relation(fields: [contractId], references: [id])
  items         GRDItem[]
  
  @@index([contractId])
  @@index([number])
  @@index([status])
  @@map("grds")
}

enum GRDSendMethod {
  EMAIL
  PHYSICAL
  CLOUD
  CD_DVD
  PENDRIVE
}

enum GRDReason {
  INITIAL       // Envio inicial
  REVISION      // Revisão
  REPLACEMENT   // Substituição
  INFORMATION   // Para informação
  APPROVAL      // Para aprovação
}

enum GRDStatus {
  DRAFT         // Rascunho
  SENT          // Enviado
  RECEIVED      // Recebido
  PENDING       // Pendente resposta
  CANCELLED     // Cancelado
}

// Itens da GRD
model GRDItem {
  id          String   @id @default(uuid())
  grdId       String
  documentId  String
  
  copies      Int      @default(1)  // Quantidade de cópias
  format      String?  // A0, A1, A2, A3, A4
  notes       String?
  
  createdAt   DateTime @default(now())
  
  grd         GRD             @relation(fields: [grdId], references: [id], onDelete: Cascade)
  document    ProjectDocument @relation(fields: [documentId], references: [id])
  
  @@index([grdId])
  @@index([documentId])
  @@map("grd_items")
}

// Anotações/Marcações em documentos
model DocumentAnnotation {
  id          String   @id @default(uuid())
  documentId  String
  
  // Tipo de anotação
  type        AnnotationType
  
  // Posição e geometria (JSON)
  geometry    Json     // {x, y, width, height, points, etc.}
  
  // Conteúdo
  text        String?
  color       String   @default("#ff0000")
  
  // Autor
  createdById   String?
  createdByName String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  document    ProjectDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  @@index([documentId])
  @@map("document_annotations")
}

enum AnnotationType {
  CIRCLE      // Círculo
  ARROW       // Seta
  TEXT        // Texto
  CLOUD       // Nuvem de revisão
  DIMENSION   // Cota/medida
  STRIKEOUT   // Riscado
  RECTANGLE   // Retângulo
  FREEHAND    // Desenho livre
}
